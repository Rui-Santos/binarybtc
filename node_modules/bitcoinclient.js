var  bitcoin = require('bitcoin')
	,fs = require('fs')
	,mongoose = require('mongoose')
	,User = require('user-model');
var client = null;
var gclient = null;
function Bitcoinconnect(next) {
fs.readFile('/home/node/keys/bitcoin.id', 'utf8', function (err,data) {
  if (err) return console.log(err);
  var id = data.replace("\n", "").replace("\r", "");
    fs.readFile('/home/node/keys/bitcoin.key', 'utf8', function (err,data) {
      if (err) return console.log(err);
    var key = data.replace("\n", "").replace("\r", "");
	    fs.readFile('/home/node/keys/bitcoin.host', 'utf8', function (err,data) {
	      if (err) return console.log(err);
	   
		    var host = data.replace("\n", "").replace("\r", "");
		    fs.readFile('/home/node/keys/bitcoin.port', 'utf8', function (err,data) {
		      if (err) return console.log(err);
			    var port = data.replace("\n", "").replace("\r", "");
				var client = new bitcoin.Client({
					host: host,
					port: port,
					user: id,
					pass: key,
					timeout: 5000
				});
				//console.log(host+':'+port);
				next(client);
			});
	    });
	});
});
}

Bitcoinconnect(function(client) {
	// After connection
	gclient = client;
	loginfo();
	//listaddresses();
	addressbalance('198px1RAx3NE4u8mXAaqWqmHN2DyRxeMeF')
	//balance('liam');
});

function loginfo(){
	gclient.cmd('getinfo', function(err, info){
	if (err) throw (err);
		console.log('Bitcoin loaded ', info);
	});
}

function listaddresses() {
	gclient.cmd('listreceivedbyaddress', 0, true, function(err, info){
	if (err) throw (err);
		console.log('Listing recieved ', info);
	});
}

function addressbalance(address, confirmations) {
	if (!confirmations) confirmations = 3;
	gclient.cmd('getbalance', address, confirmations, function(err, balance, resHeaders) {
		if (err) return console.log(err);
		console.log(address+":", balance);
	});
}

function balance(username) {
  User.findOne({ username: username }, function(err, user) {
    if (err) throw err;
    if (user != null){
    	console.log(user.bitcoin);
		gclient.cmd('getbalance', user.bitcoin, 3, function(err, balance, resHeaders) {
		  if (err) return console.log(err);
		  console.log(user.bitcoin+"'s balance: ", balance);
		});
    }
  });
}

